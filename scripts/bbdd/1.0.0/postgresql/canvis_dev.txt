


-- Actualitzar ScaneWeb i Document Custody



ALTER TABLE dib_apisimple
  ADD COLUMN perfil character varying(255) NOT NULL DEFAULT '';
  

ALTER TABLE dib_transaccio
  ADD COLUMN ip character varying(50) NOT NULL DEFAULT '10.215.216.175';
ALTER TABLE dib_transaccio
  ADD COLUMN hashescaneig character varying(255);
ALTER TABLE dib_transaccio
  ADD COLUMN hashfirma character varying(255);
  

  
  -- Table: dib_configuraciofirma

-- DROP TABLE dib_configuraciofirma;

CREATE TABLE dib_configuraciofirma
(
  configuraciofirmaid bigint NOT NULL DEFAULT nextval('dib_digitalib_seq'::regclass),
  uspoliticadefirma integer NOT NULL DEFAULT 0, -- -1=> usar politica de firma de l'entitat, 0 => no usar politica de firma,  1=> usar politica d'aquesta configuracio, 2 => L'usuari web o usuari-app elegeixen la politica de firma
  policyidentifier character varying(100),
  policyidentifierhash character varying(256),
  policyidentifierhashalgorithm character varying(50),
  policyurldocument character varying(255),
  tipusoperaciofirma integer NOT NULL DEFAULT 0, -- 0 firma, 1 contrafirma 2, cofirma
  tipusfirmaid integer NOT NULL,
  algorismedefirmaid integer  NOT NULL,
  modedefirma boolean NOT NULL,
  motiudelegacioid bigint,
  firmatperformatid bigint,
  posiciotaulafirmesid integer NOT NULL DEFAULT 0,
  pluginsegellatid bigint,
  politicacustodia integer NOT NULL DEFAULT 0, -- -1: el que digui l'entitat, 0: No permetre, 1: Només Plantilles de l''Entitat (No editables), 2: Obligatori Plantilla Entitat, 3: Opcional plantilla Entitat, 4: Opcional plantilla Entitat, 5: Llibertat Total (selecció, edició i us), 6: Custòdia de la Configuració de usuariAplicacio
  politicataulafirmes integer NOT NULL DEFAULT 0, -- -1 definit en l'entitat, 0 no es permet taules de firmes, 1  obligatori politica definida en la configuració d'usuari aplicació o entitat, 2 opcional, per defecte el definit a l'entitat
  politicasegellatdetemps integer NOT NULL DEFAULT 0, -- DEFINIT_EN_ENTITAT=-1;NOUSAR=0;US_OBLIGATORI=1;USUARI_ELEGEIX_PER_DEFECTE_SI=2;USUARI_ELEGEIX_PER_DEFECTE_NO=3;
  propietatstaulafirmes text,
  CONSTRAINT dib_configuraciofirma_pk PRIMARY KEY (configuraciofirmaid),
  CONSTRAINT dib_conffirma_plugin_seg_fk FOREIGN KEY (pluginsegellatid)
      REFERENCES dib_plugin (pluginid) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT dib_conffirma_traduccio_firm_fk FOREIGN KEY (firmatperformatid)
      REFERENCES dib_traduccio (traduccioid) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT dib_conffirma_traduccio_moti_fk FOREIGN KEY (motiudelegacioid)
      REFERENCES dib_traduccio (traduccioid) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
)
WITH (
  OIDS=FALSE
);

COMMENT ON COLUMN dib_configuraciofirma.uspoliticadefirma IS '-1=> usar politica de firma de l''entitat, 0 => no usar politica de firma,  1=> usar politica d''aquesta configuracio, 2 => L''usuari web o usuari-app elegeixen la politica de firma';
COMMENT ON COLUMN dib_configuraciofirma.tipusoperaciofirma IS '0 firma, 1 contrafirma 2, cofirma';
COMMENT ON COLUMN dib_configuraciofirma.politicacustodia IS '-1: el que digui l''entitat, 0: No permetre, 1: Només Plantilles de l''''Entitat (No editables), 2: Obligatori Plantilla Entitat, 3: Opcional plantilla Entitat, 4: Opcional plantilla Entitat, 5: Llibertat Total (selecció, edició i us), 6: Custòdia de la Configuració de usuariAplicacio';
COMMENT ON COLUMN dib_configuraciofirma.politicataulafirmes IS '-1 definit en l''entitat, 0 no es permet taules de firmes, 1  obligatori politica definida en la configuració d''usuari aplicació o entitat, 2 opcional, per defecte el definit a l''entitat';
COMMENT ON COLUMN dib_configuraciofirma.politicasegellatdetemps IS 'DEFINIT_EN_ENTITAT=-1;NOUSAR=0;US_OBLIGATORI=1;USUARI_ELEGEIX_PER_DEFECTE_SI=2;USUARI_ELEGEIX_PER_DEFECTE_NO=3;';


-- Index: dib_conffirma_algofirma_fk_i

-- DROP INDEX dib_conffirma_algofirma_fk_i;

CREATE INDEX dib_conffirma_algofirma_fk_i
  ON dib_configuraciofirma
  USING btree
  (algorismedefirmaid);


-- Index: dib_conffirma_firmatper_fk_i

-- DROP INDEX dib_conffirma_firmatper_fk_i;

CREATE INDEX dib_conffirma_firmatper_fk_i
  ON dib_configuraciofirma
  USING btree
  (firmatperformatid);


-- Index: dib_conffirma_motiudele_fk_i

-- DROP INDEX dib_conffirma_motiudele_fk_i;

CREATE INDEX dib_conffirma_motiudele_fk_i
  ON dib_configuraciofirma
  USING btree
  (motiudelegacioid);

-- Index: dib_conffirma_plugsegell_fk_i

-- DROP INDEX dib_conffirma_plugsegell_fk_i;

CREATE INDEX dib_conffirma_plugsegell_fk_i
  ON dib_configuraciofirma
  USING btree
  (pluginsegellatid);


-- Index: dib_configuraciofirma_pk_i

-- DROP INDEX dib_configuraciofirma_pk_i;

CREATE INDEX dib_configuraciofirma_pk_i
  ON dib_configuraciofirma
  USING btree
  (configuraciofirmaid);

  
  COMMENT ON COLUMN dib_configuraciofirma.uspoliticadefirma
  IS '0 => no usar politica de firma,  1=> usar politica d''aquesta configuracio';
COMMENT ON COLUMN dib_configuraciofirma.politicataulafirmes
  IS ' 0 no es permet taules de firmes, 1  obligatori politica definida en la configuració d''usuari aplicació o entitat, 2 opcional, per defecte el definit a l''entitat';
COMMENT ON COLUMN dib_configuraciofirma.uspoliticadefirma IS '0 => no usar politica de firma,  1=> usar politica d''aquesta configuracio';
COMMENT ON COLUMN dib_configuraciofirma.politicataulafirmes IS ' 0 no es permet taules de firmes, 1  obligatori politica definida en la configuració d''usuari aplicació o entitat, 2 opcional, per defecte el definit a l''entitat';


-- ==== ERRORS EN TAULA ]ConfiguracioFirma[:

-- La ForeignKey dib_conffirma_traduccio_firm_fk de la taula ConfiguracioFirma té un tamany de més de 30 caracters
-- La ForeignKey dib_conffirma_traduccio_firm_fk de la taula ConfiguracioFirma no té un nom correcte (esperat dib_conffirma_traduccio_*_fk )
ALTER TABLE dib_configuraciofirma DROP CONSTRAINT dib_conffirma_traduccio_firm_fk;
ALTER TABLE dib_configuraciofirma ADD CONSTRAINT dib_conffirma_traduccio_ff_fk  FOREIGN KEY (firmatperformatid)  REFERENCES dib_traduccio (traduccioid);
-- La ForeignKey dib_conffirma_traduccio_moti_fk de la taula ConfiguracioFirma té un tamany de més de 30 caracters
-- La ForeignKey dib_conffirma_traduccio_moti_fk de la taula ConfiguracioFirma no té un nom correcte (esperat dib_conffirma_traduccio_*_fk )
ALTER TABLE dib_configuraciofirma DROP CONSTRAINT dib_conffirma_traduccio_moti_fk;
ALTER TABLE dib_configuraciofirma ADD CONSTRAINT dib_conffirma_traduccio_md_fk  FOREIGN KEY (motiudelegacioid)  REFERENCES dib_traduccio (traduccioid);


  
